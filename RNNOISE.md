# Инструкция по включению оптимизированной сборки rnnoise в проект

## Зависимости

В зависимости проекта неоходимо добавить модуль `"@jitsi/rnnoise-wasm": "github:MarkTiukov/rnnoise-wasm#master"`

## Фильтр

Сама обработка аудио осуществляется реализацией [аудио ноды](https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletNode), как это сделано [тут](src\content\peerconnection\webaudio-input\js\rnnoise-processor.js)

Пояснения:

* В конструкторе сначала создаем модуль `rnnModule` -- объект, через который мы обращаемся к методам библиотеки rnnoise, написанной на Си. Затем инициализируем память буфера `inputBuffer`, куда будем записывать полученные из вне данные с микрофона для дальнейшей обработки, и получаем указатель на данные `inputBufferF32Index`. Последний шаг конструктора: создаем внутреннюю переменную для rnnoise.
* Метод `process(inputs, outputs, parameters)` является внешней ручкой API аудио нод. Он принимает на вход массив инпутов и просит выходной поток положить в outputs. Для обработки входных данных сначала копируем эти данные в память rnnoise (в `rnnModule.HEAPF32`), учитывая, что на вход аудио ноды прилетает 128 сэмплов, а rnnoise работает с 480, после чего вызываем обработку функцией `rnnModule._rnnoise_process_frame`. Наконец, копируем обработанные данные из памяти rnnoise модуля в массив, который передала аудио нода.
* Также необходимо зарегестрировать нашу ноду-обработчик в общем списке (чтобы позже инициализировать и добавить в цепочку). Для этого нужно в том же файле вне класса прописать `registerProcessor('rnnoise-processor', RnnoiseProcessor)`, где первый аргумент -- идентификатор (может быть любым неповторяющимся), второй -- название класса

## Work-flow

Встраивание rnnoise осуществляется через добавление ещё одной аудио ноды в цепочку, через которую подается аудио в наушники или колонку.

Для этого необходимо создать объект соответствующего класса и подключить его в цепочку, к предыдущей использущейся ноде:

```JS
new AudioWorkletNode(this.context, 'rnnoise-processor');
// ...
this.filter.connect(this.peer);
```

[Пример находится тут](src\content\peerconnection\webaudio-input\js\webaudioextended.js)
